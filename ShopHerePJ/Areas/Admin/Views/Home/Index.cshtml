@using System.Text.Json
@model ShopHerePJ.Models.AdminDashboardVM

@{
    ViewData["Title"] = "Dashboard";
}

<style>
    .stat-card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
    }

        .stat-card .icon-wrap {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(13,110,253,.08);
        }

    .card {
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,.06);
    }

    .card-header {
        border-bottom: 1px solid rgba(0,0,0,.06) !important;
    }

    .chart-wrap {
        height: 320px;
    }

    .kpi-sub {
        font-size: 12px;
        color: #6c757d;
    }

    .badge-soft {
        background: rgba(13,110,253,.08);
        color: #0d6efd;
        border: 1px solid rgba(13,110,253,.12);
    }
</style>

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-1">Admin Dashboard</h1>
            <small class="text-muted">Tổng quan hệ thống quản trị</small>
        </div>
        <div class="d-flex gap-2">
            <a asp-area="Admin" asp-controller="Users" asp-action="Index" class="btn btn-outline-primary btn-sm">Manage Users</a>
            <a asp-area="Admin" asp-controller="Products" asp-action="Index" class="btn btn-outline-secondary btn-sm">Manage Products</a>
        </div>
    </div>

    <!-- KPI -->
    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">Orders (7 days)</div>
                            <div class="fs-4 fw-bold">@Model.TotalOrders7d</div>
                            <div class="kpi-sub">Tổng số đơn 7 ngày gần nhất</div>
                        </div>
                        <div class="icon-wrap"><i class="bi bi-receipt text-primary"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">Users</div>
                            <div class="fs-4 fw-bold">@Model.TotalUsersActive</div>
                            <div class="kpi-sub">Active: @Model.TotalUsersActive • Locked: @Model.TotalUsersLocked</div>
                        </div>
                        <div class="icon-wrap" style="background: rgba(25,135,84,.08);">
                            <i class="bi bi-people text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">Products</div>
                            <div class="fs-4 fw-bold">@Model.TotalProductsActive</div>
                            <div class="kpi-sub">Low stock variants: @Model.LowStockVariants</div>
                        </div>
                        <div class="icon-wrap" style="background: rgba(108,117,125,.08);">
                            <i class="bi bi-box-seam text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">Revenue (this month)</div>
                            <div class="fs-4 fw-bold">@Model.RevenueThisMonth.ToString("N0") đ</div>
                            <div class="kpi-sub">Loại cancelled/refunded</div>
                        </div>
                        <div class="icon-wrap" style="background: rgba(255,193,7,.14);">
                            <i class="bi bi-cash-coin text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-3">
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">Orders & Revenue (7 days)</span>
                    <span class="badge badge-soft">Live</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrap">
                        <canvas id="barOrders"></canvas>
                    </div>
                    <div class="small text-muted mt-2">Bar: Orders • Line: Revenue (VND)</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">Order Status (7 days)</span>
                    <span class="badge bg-light text-muted">Live</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrap">
                        <canvas id="pieStatus"></canvas>
                    </div>
                    <div class="small text-muted mt-2">Tỉ lệ trạng thái đơn hàng</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row g-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white border-0">
                    <span class="fw-semibold">Quick actions</span>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a asp-area="Admin" asp-controller="Users" asp-action="Create" class="btn btn-primary">
                            <i class="bi bi-person-plus me-1"></i> Create User
                        </a>
                        <a asp-area="Admin" asp-controller="Categories" asp-action="Create" class="btn btn-outline-primary">
                            <i class="bi bi-tag me-1"></i> Create Category
                        </a>
                        <a asp-area="Admin" asp-controller="Products" asp-action="Create" class="btn btn-outline-secondary">
                            <i class="bi bi-plus-square me-1"></i> Create Product
                        </a>
                        <a asp-area="Admin" asp-controller="Orders" asp-action="Index" class="btn btn-outline-dark">
                            <i class="bi bi-receipt-cutoff me-1"></i> View Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // ===== Data from server =====
        const labels = @Html.Raw(JsonSerializer.Serialize(Model.Labels7d));
        const orders = @Html.Raw(JsonSerializer.Serialize(Model.Orders7d));
        const revenue = @Html.Raw(JsonSerializer.Serialize(Model.Revenue7d));

        const statusLabels = @Html.Raw(JsonSerializer.Serialize(Model.StatusLabels));
        const statusCounts = @Html.Raw(JsonSerializer.Serialize(Model.StatusCounts));

        // ===== Bar + Line =====
        new Chart(document.getElementById("barOrders"), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "Orders", data: orders, borderWidth: 0, borderRadius: 10 },
                    { label: "Revenue (VND)", type: "line", data: revenue, yAxisID: "y1", tension: 0.35, pointRadius: 3 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                if (ctx.dataset.label.includes("Revenue")) {
                                    return `${ctx.dataset.label}: ${Number(ctx.raw).toLocaleString()} đ`;
                                }
                                return `${ctx.dataset.label}: ${ctx.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    y1: {
                        beginAtZero: true,
                        position: "right",
                        grid: { drawOnChartArea: false },
                        ticks: { callback: v => Number(v).toLocaleString() + " đ" }
                    }
                }
            }
        });

        // ===== Doughnut =====
        new Chart(document.getElementById("pieStatus"), {
            type: "doughnut",
            data: {
                labels: statusLabels,
                datasets: [{ data: statusCounts, borderWidth: 0 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "68%",
                plugins: { legend: { position: "bottom" } }
            }
        });
    </script>
}
